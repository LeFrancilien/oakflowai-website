{
  "name": "TikTok - Workflow Complet avec Logging [PRODUCTION]",
  "nodes": [
    {
      "id": "f1a2b3c4-5678-90ab-cdef-111111111111",
      "name": "üé¨ WORKFLOW TIKTOK AUTOMATION",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, 80],
      "parameters": {
        "content": "# üé¨ Workflow Automatisation TikTok\n\n## Flux complet :\n1Ô∏è‚É£ R√©ception webhook formulaire\n2Ô∏è‚É£ Configuration par d√©faut\n3Ô∏è‚É£ **Agent IA** g√©n√®re 5 scripts (GPT-4o-mini)\n4Ô∏è‚É£ **Parse + Validation** JSON robuste\n5Ô∏è‚É£ **Scoring KIE.ai** pour d√©tecter viralit√©\n6Ô∏è‚É£ **S√©lection meilleure id√©e** + Fallback\n7Ô∏è‚É£ **üìä Logging Google Sheets** (scores + m√©tadata)\n8Ô∏è‚É£ Construction voiceover + caption\n9Ô∏è‚É£ G√©n√©ration vid√©o **Heygen**\nüîü Publication **TikTok**\n\n---\n**Status** : üß™ TEST\n**Version** : 2.1\n**Date** : 2025-10-27",
        "height": 440,
        "width": 340,
        "color": 4
      }
    },
    {
      "id": "89d77201-7ec8-4ec6-b459-437452666d37",
      "name": "Trigger Form (Webhook)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300],
      "parameters": {
        "httpMethod": "POST",
        "path": "tiktok-script-ideas",
        "responseMode": "onReceived",
        "responseData": "allEntries",
        "options": {
          "responseCode": 200
        }
      }
    },
    {
      "id": "f2a3b4c5-6789-01bc-def2-222222222222",
      "name": "üìù Configuration Defaults",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [380, 180],
      "parameters": {
        "content": "## ‚öôÔ∏è Set Defaults\n\nR√©cup√®re les param√®tres du webhook ou applique les valeurs par d√©faut :\n- Topic\n- Tone\n- Language\n- Hashtags\n- Duration",
        "height": 180,
        "width": 240,
        "color": 6
      }
    },
    {
      "id": "4c410f0f-eb8f-436f-910a-20c57b080145",
      "name": "Set Defaults",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [420, 300],
      "parameters": {
        "keepOnlySet": false,
        "values": {
          "string": [
            {
              "name": "topic",
              "value": "={{$json.body?.topic || 'Automations IA pour cr√©ateurs de contenu'}}"
            },
            {
              "name": "tone",
              "value": "={{$json.body?.tone || '√©nergique, p√©dagogique, punchy'}}"
            },
            {
              "name": "language",
              "value": "={{$json.body?.language || 'fr'}}"
            },
            {
              "name": "hashtags",
              "value": "={{$json.body?.hashtags || '#n8n #Automation #IA #Workflow #Heygen'}}"
            }
          ],
          "number": [
            {
              "name": "targetDurationSec",
              "value": "={{$json.body?.duration || 15}}"
            }
          ]
        }
      }
    },
    {
      "id": "f3a4b5c6-7890-12cd-ef33-333333333333",
      "name": "ü§ñ Agent IA - G√©n√©ration",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [620, 180],
      "parameters": {
        "content": "## ü§ñ Agent IA + Output Parser\n\n**Architecture** :\n- Agent AI (orchestrateur)\n- Chat Model GPT-4o-mini (T=0.3)\n- Structured Output Parser (JSON)\n\n**Output** : 5 scripts TikTok avec :\n- Hook (< 3s)\n- Flow (3-5 steps)\n- Result\n- Outro\n- Caption (140 char)\n- Voiceover (15s)",
        "height": 260,
        "width": 260,
        "color": 5
      }
    },
    {
      "id": "chat-model-openai",
      "name": "OpenAI Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [580, 460],
      "credentials": {
        "openAiApi": {
          "id": "CONFIGURE_OPENAI_CREDENTIAL",
          "name": "OpenAI account"
        }
      },
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.3,
          "maxTokens": 1500
        }
      }
    },
    {
      "id": "output-parser-structured",
      "name": "Structured Output Parser",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1,
      "position": [760, 460],
      "parameters": {
        "jsonSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"ideas\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"hook\": {\n            \"type\": \"string\",\n            \"description\": \"Phrase d'accroche ultra-percutante de moins de 3 secondes\"\n          },\n          \"flow_steps\": {\n            \"type\": \"array\",\n            \"items\": {\"type\": \"string\"},\n            \"description\": \"Entre 3 et 5 √©tapes courtes et actionnables\"\n          },\n          \"result\": {\n            \"type\": \"string\",\n            \"description\": \"R√©sultat concret et b√©n√©fice clair\"\n          },\n          \"outro\": {\n            \"type\": \"string\",\n            \"description\": \"Call-to-action engageant\"\n          },\n          \"caption_140\": {\n            \"type\": \"string\",\n            \"description\": \"Caption TikTok de maximum 140 caract√®res\"\n          },\n          \"voiceover_15s\": {\n            \"type\": \"string\",\n            \"description\": \"Texte voix-off adapt√© √† 15 secondes de narration\"\n          }\n        },\n        \"required\": [\"hook\", \"flow_steps\", \"result\", \"outro\", \"caption_140\", \"voiceover_15s\"]\n      },\n      \"minItems\": 5,\n      \"maxItems\": 5\n    }\n  },\n  \"required\": [\"ideas\"]\n}"
      }
    },
    {
      "id": "ffd348ab-8e65-4859-9c77-84f1f043802d",
      "name": "Agent IA ‚Üí G√©n√®re 5 scripts",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.8,
      "position": [660, 300],
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un expert cr√©ateur de scripts TikTok viraux optimis√©s pour maximiser l'engagement.\n\n**CONTEXTE DU PROJET**\nSujet : {{ $('Set Defaults').first().json.topic }}\nTon recherch√© : {{ $('Set Defaults').first().json.tone }}\nLangue : {{ $('Set Defaults').first().json.language }}\nDur√©e cible : {{ $('Set Defaults').first().json.targetDurationSec }} secondes\n\n**TA MISSION**\nG√©n√®re EXACTEMENT 5 id√©es de scripts TikTok diff√©rents et captivants sur ce sujet.\n\n**R√àGLES STRICTES POUR CHAQUE SCRIPT**\n\n1. **HOOK** (< 3 secondes)\n   - Phrase d'accroche ULTRA-percutante\n   - Doit stopper le scroll imm√©diatement\n   - Maximum 10-12 mots\n   - Commence par une question, un fait surprenant, ou une promesse claire\n\n2. **FLOW_STEPS** (3 √† 5 √©tapes)\n   - Chaque √©tape = 1 action concr√®te et simple\n   - Langage direct et actionnable\n   - Progression logique du probl√®me √† la solution\n   - Pas de jargon technique\n\n3. **RESULT** (r√©sultat)\n   - B√©n√©fice CONCRET et mesurable\n   - Doit cr√©er le d√©sir d'appliquer le conseil\n   - Focalis√© sur la transformation\n\n4. **OUTRO** (call-to-action)\n   - Invitation claire √† agir\n   - Engagement de la communaut√©\n   - Question ou challenge\n\n5. **CAPTION_140** (140 caract√®res MAX)\n   - R√©sum√© punchy du script\n   - Pas d'emojis (seront ajout√©s s√©par√©ment)\n   - Inclut un teaser du b√©n√©fice\n\n6. **VOICEOVER_15S** (voix-off compl√®te)\n   - Texte fluide pour narration orale\n   - Adapt√© √† {{ $('Set Defaults').first().json.targetDurationSec }} secondes de lecture\n   - Pas d'emojis, pas de symboles\n   - Style conversationnel naturel\n   - Int√®gre : hook + flow + result + outro\n\n**FORMAT DE SORTIE**\nR√©ponds UNIQUEMENT avec un objet JSON contenant un tableau \"ideas\" de 5 objets.\nLe parser structur√© forcera automatiquement le bon format.\n\n**EXEMPLE DE QUALIT√â ATTENDUE**\n- Hook : \"Tu perds 3h par jour sur des t√¢ches automatisables ?\"\n- Flow : [\"Identifie les t√¢ches r√©p√©titives\", \"Configure n8n en 5 min\", \"Connecte tes outils\", \"Lance l'automation\"]\n- Result : \"√âconomise 15h par semaine pour cr√©er du contenu\"\n- Outro : \"Quelle t√¢che vas-tu automatiser en premier ?\"\n\n**VARIATIONS REQUISES**\nChaque des 5 id√©es DOIT avoir :\n- Un angle diff√©rent sur le sujet\n- Un hook unique\n- Des √©tapes compl√©mentaires (pas de r√©p√©tition)\n- Un ton coh√©rent mais des approches vari√©es\n\nüéØ OBJECTIF : Maximiser les chances de viralit√© en offrant 5 approches diff√©rentes du m√™me sujet.",
        "hasOutputParser": true,
        "options": {}
      }
    },
    {
      "id": "f4a5b6c7-8901-23de-f444-444444444444",
      "name": "üîç Parsing & Validation",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [900, 180],
      "parameters": {
        "content": "## üîç Validation Simplifi√©e\n\n‚úÖ Output Parser garantit le format\n‚úÖ Validation des champs obligatoires\n‚úÖ V√©rification des contraintes\n‚úÖ Logs de qualit√©\n‚ö†Ô∏è Fallback si erreur",
        "height": 200,
        "width": 260,
        "color": 3
      }
    },
    {
      "id": "3e215f6f-ac1f-4673-8c0b-fe675e97f251",
      "name": "Parse JSON (id√©es)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, 300],
      "parameters": {
        "jsCode": "// üîç VALIDATION SIMPLIFI√âE - Le Structured Output Parser garantit le format JSON\n\ntry {\n  // R√©cup√©ration des donn√©es depuis l'Agent IA\n  const agentOutput = $input.first().json;\n  \n  console.log('üì• R√©ception output Agent IA');\n  console.log('Type:', typeof agentOutput);\n  console.log('Keys:', Object.keys(agentOutput));\n  \n  // Le Structured Output Parser retourne directement l'objet structur√©\n  let ideas;\n  \n  // Gestion de diff√©rentes structures possibles\n  if (agentOutput.output && Array.isArray(agentOutput.output.ideas)) {\n    ideas = agentOutput.output.ideas;\n  } else if (agentOutput.ideas && Array.isArray(agentOutput.ideas)) {\n    ideas = agentOutput.ideas;\n  } else if (Array.isArray(agentOutput)) {\n    // Fallback : si c'est directement un tableau\n    ideas = agentOutput;\n  } else {\n    throw new Error(\n      '‚ùå ERREUR STRUCTURE: Format de sortie Agent IA non reconnu. ' +\n      `Re√ßu: ${JSON.stringify(agentOutput).slice(0, 200)}`\n    );\n  }\n  \n  if (!ideas || ideas.length === 0) {\n    throw new Error('‚ùå ERREUR: Aucune id√©e g√©n√©r√©e par l\\'Agent IA');\n  }\n  \n  console.log(`‚úÖ ${ideas.length} id√©es d√©tect√©es`);\n  \n  // Validation de chaque id√©e\n  const requiredFields = [\n    'hook', 'flow_steps', 'result', 'outro', 'caption_140', 'voiceover_15s'\n  ];\n  \n  const validatedIdeas = ideas.map((idea, idx) => {\n    // V√©rification des champs obligatoires\n    const missingFields = requiredFields.filter(field => !idea[field]);\n    \n    if (missingFields.length > 0) {\n      throw new Error(\n        `‚ùå ERREUR VALIDATION - Id√©e ${idx + 1}: ` +\n        `champs manquants ‚Üí ${missingFields.join(', ')}`\n      );\n    }\n    \n    // Validation flow_steps\n    if (!Array.isArray(idea.flow_steps)) {\n      throw new Error(\n        `‚ùå ERREUR - Id√©e ${idx + 1}: ` +\n        `flow_steps doit √™tre un tableau, re√ßu: ${typeof idea.flow_steps}`\n      );\n    }\n    \n    if (idea.flow_steps.length < 3) {\n      throw new Error(\n        `‚ùå ERREUR - Id√©e ${idx + 1}: ` +\n        `flow_steps doit contenir min 3 √©l√©ments, re√ßu: ${idea.flow_steps.length}`\n      );\n    }\n    \n    // Validation longueur caption\n    if (idea.caption_140.length > 140) {\n      console.warn(\n        `‚ö†Ô∏è WARNING - Id√©e ${idx + 1}: ` +\n        `caption tronqu√©e (${idea.caption_140.length} ‚Üí 140 caract√®res)`\n      );\n      idea.caption_140 = idea.caption_140.slice(0, 137) + '...';\n    }\n    \n    // Validation longueur hook\n    if (idea.hook.length > 100) {\n      console.warn(`‚ö†Ô∏è Hook long pour id√©e ${idx + 1}: ${idea.hook.length} caract√®res`);\n    }\n    \n    // Validation voiceover non vide\n    if (idea.voiceover_15s.length < 50) {\n      console.warn(\n        `‚ö†Ô∏è WARNING - Id√©e ${idx + 1}: ` +\n        `voiceover tr√®s court (${idea.voiceover_15s.length} caract√®res)`\n      );\n    }\n    \n    return {\n      json: {\n        idx: idx + 1,\n        ...idea,\n        validated: true,\n        validation_timestamp: new Date().toISOString(),\n        flow_steps_count: idea.flow_steps.length,\n        caption_length: idea.caption_140.length,\n        voiceover_length: idea.voiceover_15s.length,\n        hook_length: idea.hook.length\n      }\n    };\n  });\n  \n  // Log de succ√®s avec statistiques d√©taill√©es\n  console.log(`‚úÖ SUCCESS: ${validatedIdeas.length} id√©es valid√©es`);\n  console.log('üìä Statistiques d√©taill√©es:', {\n    total: validatedIdeas.length,\n    avg_caption_length: Math.round(\n      validatedIdeas.reduce((sum, v) => sum + v.json.caption_length, 0) / validatedIdeas.length\n    ),\n    avg_voiceover_length: Math.round(\n      validatedIdeas.reduce((sum, v) => sum + v.json.voiceover_length, 0) / validatedIdeas.length\n    ),\n    avg_flow_steps: (validatedIdeas.reduce((sum, v) => sum + v.json.flow_steps_count, 0) / validatedIdeas.length).toFixed(1),\n    avg_hook_length: Math.round(\n      validatedIdeas.reduce((sum, v) => sum + v.json.hook_length, 0) / validatedIdeas.length\n    )\n  });\n  \n  return validatedIdeas;\n  \n} catch(error) {\n  // Gestion d'erreur robuste avec logs d√©taill√©s\n  console.error('üö® ERREUR CRITIQUE VALIDATION:', error.message);\n  console.error('Stack:', error.stack);\n  \n  // Log du contenu re√ßu pour debug\n  try {\n    console.error('Contenu re√ßu:', JSON.stringify($input.first().json).slice(0, 500));\n  } catch(e) {\n    console.error('Impossible de logger le contenu re√ßu');\n  }\n  \n  // Retour d'erreur structur√© pour le workflow\n  throw new Error(\n    `VALIDATION FAILED: ${error.message}\\n\\n` +\n    `Action requise: \\n` +\n    `1. V√©rifier la configuration du Structured Output Parser\\n` +\n    `2. V√©rifier le prompt de l'Agent IA\\n` +\n    `3. Consulter les logs pour plus de d√©tails`\n  );\n}"
      },
      "onError": "continueErrorOutput"
    },
    {
      "id": "f5a6b7c8-9012-34ef-5555-555555555555",
      "name": "üìä Scoring Viral KIE",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1180, 180],
      "parameters": {
        "content": "## üìä API KIE - Scoring\n\n**Endpoint** : /v1/score\n**M√©thode** : POST\n**Timeout** : 30s\n**Retry** : 2 tentatives\n\n**Analyse** :\n- Hook quality\n- Flow structure\n- Result impact\n- Overall virality score",
        "height": 220,
        "width": 260,
        "color": 2
      }
    },
    {
      "id": "5d3c2f02-4bbd-4d84-8d1e-dda272e6af3a",
      "name": "api.kie ‚Üí Score Viral",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1220, 300],
      "parameters": {
        "url": "https://api.kie.ai/v1/score",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"items\": [\n    {\n      \"hook\": {{ JSON.stringify($json.hook) }},\n      \"flow\": {{ JSON.stringify($json.flow_steps) }},\n      \"result\": {{ JSON.stringify($json.result) }},\n      \"outro\": {{ JSON.stringify($json.outro) }}\n    }\n  ],\n  \"metric\": \"virality_ia_v1\"\n}",
        "options": {
          "timeout": 30000,
          "retry": {
            "enabled": true,
            "maxRetries": 2,
            "waitBetweenRetries": 1000
          }
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_KIE_CREDENTIAL",
          "name": "KIE API"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "id": "f6a7b8c9-0123-45f6-6666-666666666666",
      "name": "üèÜ S√©lection Meilleure Id√©e",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1460, 180],
      "parameters": {
        "content": "## üèÜ Pick Best Idea\n\n**Strat√©gie** :\n1. Tri par score KIE d√©croissant\n2. S√©lection du top score\n3. Fallback si API √©choue\n4. Logging complet\n\n**Fallbacks** :\n- API KIE down ‚Üí 1√®re id√©e\n- Scores invalides ‚Üí 1√®re id√©e\n- Erreur critique ‚Üí emergency fallback",
        "height": 260,
        "width": 280,
        "color": 1
      }
    },
    {
      "id": "02bc3649-ed04-4bb2-b53f-f7b0168acf65",
      "name": "Pick Best Idea",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1500, 300],
      "parameters": {
        "jsCode": "// üèÜ S√âLECTION MEILLEURE ID√âE + FALLBACKS ROBUSTES\n\ntry {\n  // R√©cup√©ration de toutes les id√©es pars√©es\n  const ideasNode = $('Parse JSON (id√©es)');\n  const ideas = ideasNode.all().map(it => it.json);\n  \n  if (!ideas || ideas.length === 0) {\n    throw new Error('‚ùå ERREUR: Aucune id√©e disponible pour s√©lection');\n  }\n  \n  console.log(`üìä D√©but s√©lection sur ${ideas.length} id√©es`);\n  \n  // R√©cup√©ration des scores depuis l'API KIE\n  const scoredItems = $input.all().map((it, i) => {\n    let score = 0;\n    let has_api_score = false;\n    let api_response_status = 'unknown';\n    \n    // Extraction du score avec gestion de multiples structures\n    if (it.json?.data?.scores?.[0] !== undefined) {\n      score = parseFloat(it.json.data.scores[0]);\n      has_api_score = true;\n      api_response_status = 'success';\n    } else if (it.json?.data?.score !== undefined) {\n      score = parseFloat(it.json.data.score);\n      has_api_score = true;\n      api_response_status = 'success';\n    } else if (it.json?.score !== undefined) {\n      score = parseFloat(it.json.score);\n      has_api_score = true;\n      api_response_status = 'success';\n    } else if (it.json?.error) {\n      console.warn(`‚ö†Ô∏è Erreur API KIE pour id√©e ${i + 1}: ${it.json.error}`);\n      api_response_status = 'error';\n      score = 0;\n    } else {\n      console.warn(`‚ö†Ô∏è Structure de r√©ponse inconnue pour id√©e ${i + 1}`);\n      api_response_status = 'no_data';\n      score = 0;\n    }\n    \n    return {\n      index: i,\n      idea_number: i + 1,\n      score: isNaN(score) ? 0 : score,\n      idea: ideas[i],\n      has_api_score,\n      api_response_status\n    };\n  });\n  \n  // V√©rification si on a au moins un score valide\n  const hasValidScores = scoredItems.some(item => item.has_api_score && item.score > 0);\n  \n  if (!hasValidScores) {\n    console.warn('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FALLBACK ACTIV√â ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è');\n    console.warn('Raison: Aucun score KIE valide d√©tect√©');\n    console.warn('Action: S√©lection de la premi√®re id√©e par d√©faut');\n    \n    return [{\n      json: {\n        best: ideas[0],\n        score: 0,\n        rank: 1,\n        total_ideas: ideas.length,\n        fallback_used: true,\n        fallback_reason: 'API KIE non disponible ou scores invalides',\n        selection_method: 'first_by_default',\n        timestamp: new Date().toISOString(),\n        all_api_statuses: scoredItems.map(s => s.api_response_status)\n      }\n    }];\n  }\n  \n  // Tri par score d√©croissant\n  scoredItems.sort((a, b) => b.score - a.score);\n  \n  // S√©lection de la meilleure id√©e\n  const topIdea = scoredItems[0];\n  const scores = scoredItems.map(s => s.score);\n  \n  // Logs d√©taill√©s\n  console.log('‚úÖ‚úÖ‚úÖ S√âLECTION R√âUSSIE ‚úÖ‚úÖ‚úÖ');\n  console.log(`üèÜ Meilleure id√©e: #${topIdea.idea_number}`);\n  console.log(`üìä Score: ${topIdea.score.toFixed(2)}`);\n  console.log(`üìà Tous les scores: [${scores.map(s => s.toFixed(2)).join(', ')}]`);\n  console.log(`üìä Stats: min=${Math.min(...scores).toFixed(2)}, max=${Math.max(...scores).toFixed(2)}, avg=${(scores.reduce((a,b) => a+b, 0)/scores.length).toFixed(2)}`);\n  \n  return [{\n    json: {\n      best: topIdea.idea,\n      score: topIdea.score,\n      rank: 1,\n      idea_number: topIdea.idea_number,\n      total_ideas: ideas.length,\n      score_stats: {\n        min: Math.min(...scores),\n        max: Math.max(...scores),\n        avg: scores.reduce((a,b) => a+b, 0) / scores.length,\n        scores_array: scores\n      },\n      all_scores: scoredItems.map(s => ({\n        idea_number: s.idea_number,\n        score: s.score,\n        api_status: s.api_response_status\n      })),\n      fallback_used: false,\n      selection_method: 'kie_api_scoring',\n      timestamp: new Date().toISOString()\n    }\n  }];\n  \n} catch(error) {\n  // üö® FALLBACK ULTIME EN CAS D'ERREUR CRITIQUE\n  console.error('üö®üö®üö® ERREUR CRITIQUE üö®üö®üö®');\n  console.error('Message:', error.message);\n  console.error('Stack:', error.stack);\n  \n  // Tentative de r√©cup√©ration des id√©es\n  try {\n    const ideas = $('Parse JSON (id√©es)').all().map(it => it.json);\n    \n    if (ideas && ideas.length > 0) {\n      console.warn('‚ö†Ô∏è FALLBACK CRITIQUE: Retour de la premi√®re id√©e disponible');\n      \n      return [{\n        json: {\n          best: ideas[0],\n          score: 0,\n          fallback_used: true,\n          fallback_reason: `Erreur critique: ${error.message}`,\n          selection_method: 'emergency_fallback',\n          total_ideas: ideas.length,\n          timestamp: new Date().toISOString(),\n          error_details: {\n            message: error.message,\n            type: error.name\n          }\n        }\n      }];\n    }\n  } catch(fallbackError) {\n    console.error('üö® Impossible de r√©cup√©rer les id√©es:', fallbackError.message);\n  }\n  \n  throw new Error(\n    `S√âLECTION FAILED: ${error.message}\\n\\n` +\n    `Aucune id√©e disponible pour fallback. V√©rifier les nodes en amont.`\n  );\n}"
      },
      "onError": "continueErrorOutput"
    },
    {
      "id": "f7a8b9c0-1234-56f7-7777-777777777777",
      "name": "üìä Logging Google Sheets",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1760, 180],
      "parameters": {
        "content": "## üìä Logging Scores\n\n**Destination** : Google Sheets\n**Action** : Append Row\n\n**Donn√©es enregistr√©es** :\n- Timestamp\n- Meilleure id√©e (hook)\n- Score viral\n- M√©thode de s√©lection\n- Fallback utilis√© ?\n- Statistiques compl√®tes\n- Topic & Tone",
        "height": 260,
        "width": 280,
        "color": 7
      }
    },
    {
      "id": "log-to-sheets",
      "name": "üìä Log ‚Üí Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [1800, 300],
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "list",
          "value": "CONFIGURE_YOUR_SHEET_ID_HERE"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "hook": "={{ $json.best.hook }}",
            "score": "={{ $json.score }}",
            "selection_method": "={{ $json.selection_method }}",
            "fallback_used": "={{ $json.fallback_used ? 'OUI' : 'NON' }}",
            "total_ideas": "={{ $json.total_ideas }}",
            "min_score": "={{ $json.score_stats?.min || 0 }}",
            "max_score": "={{ $json.score_stats?.max || 0 }}",
            "avg_score": "={{ $json.score_stats?.avg || 0 }}",
            "topic": "={{ $('Set Defaults').first().json.topic }}",
            "tone": "={{ $('Set Defaults').first().json.tone }}",
            "caption": "={{ $json.best.caption_140 }}"
          }
        },
        "options": {}
      },
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "CONFIGURE_GOOGLE_SHEETS_CREDENTIAL",
          "name": "Google Sheets account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "id": "f8a9b0c1-2345-67f8-8888-888888888888",
      "name": "üé• G√©n√©ration Vid√©o",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [2060, 180],
      "parameters": {
        "content": "## üé• Heygen Video Pipeline\n\n1. **Build Voiceover + Caption**\n2. **Generate Video** (Heygen API)\n3. **Poll Status** (wait 5s loop)\n4. **Check if ready**\n5. **Get MP4 URL**\n6. **Download Binary**\n7. **Publish TikTok**",
        "height": 220,
        "width": 300,
        "color": 4
      }
    },
    {
      "id": "dff878f1-4879-4e6b-b901-e5a4ccb09c50",
      "name": "Build Voiceover + Caption",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2100, 300],
      "parameters": {
        "jsCode": "const best = $input.first().json.best;\nconst defaults = $('Set Defaults').first().json;\nconst hashtags = defaults.hashtags;\n\nconst voiceover = best.voiceover_15s;\nconst caption = (best.caption_140 + ' ' + hashtags).trim().slice(0, 2200);\n\nconst pickBestData = $input.first().json;\n\nreturn [{ \n  json: { \n    voiceover, \n    caption,\n    score: pickBestData.score || 0,\n    selection_method: pickBestData.selection_method || 'unknown',\n    fallback_used: pickBestData.fallback_used || false,\n    idea_number: pickBestData.idea_number || 1\n  } \n}];"
      }
    },
    {
      "id": "5ed21c34-259b-4717-9bf0-368b6d860a70",
      "name": "Heygen ‚Üí Generate Video",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [2340, 300],
      "parameters": {
        "url": "https://api.heygen.com/v2/video/generate",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"title\": \"TikTok - Workflow IA\",\n  \"test\": false,\n  \"video_inputs\": [\n    {\n      \"avatar_id\": \"VOTRE_AVATAR_ID\",\n      \"input_text\": {{ JSON.stringify($json.voiceover) }},\n      \"voice_id\": \"VOTRE_VOICE_ID\"\n    }\n  ],\n  \"dimension\": {\n    \"width\": 1080,\n    \"height\": 1920\n  }\n}",
        "options": {
          "timeout": 120000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_HEYGEN_CREDENTIAL",
          "name": "Heygen API"
        }
      }
    },
    {
      "id": "5a46c8a6-baab-4c1e-920e-039eae74e3ed",
      "name": "Heygen ‚Üí Poll Status",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [2580, 300],
      "parameters": {
        "url": "={{\"https://api.heygen.com/v1/video_status.get?video_id=\" + $json.data?.video_id}}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_HEYGEN_CREDENTIAL",
          "name": "Heygen API"
        }
      }
    },
    {
      "id": "f4e7cdcf-0f5e-461a-a022-f294e9d3c707",
      "name": "Wait 5s",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [2800, 300],
      "parameters": {
        "amount": 5,
        "unit": "seconds"
      }
    },
    {
      "id": "43344644-4fa1-4ad3-a568-606c6971f261",
      "name": "IF Video Ready?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [3020, 300],
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.data?.status}}",
              "operation": "equal",
              "value2": "completed"
            }
          ]
        }
      }
    },
    {
      "id": "0fffd4d2-7484-4838-8a05-6369e96cbc5b",
      "name": "Heygen ‚Üí Get MP4 URL",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3260, 220],
      "parameters": {
        "url": "={{\"https://api.heygen.com/v1/video.get?video_id=\" + $('Heygen ‚Üí Poll Status').first().json.data?.video_id}}",
        "method": "GET",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_HEYGEN_CREDENTIAL",
          "name": "Heygen API"
        }
      }
    },
    {
      "id": "a547449f-3cf1-4f4e-82fb-d4acb4bd3b6b",
      "name": "Download MP4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3500, 220],
      "parameters": {
        "url": "={{$json.data?.video_url}}",
        "method": "GET",
        "responseFormat": "file",
        "options": {
          "timeout": 120000
        }
      }
    },
    {
      "id": "b815c767-4ae3-44f8-beb5-3a934eb39cc5",
      "name": "Switch TikTok Method",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [3720, 220],
      "parameters": {
        "value": "=DIRECT_URL",
        "rules": {
          "rules": [
            {
              "operation": "equal",
              "value": "DIRECT_URL"
            },
            {
              "operation": "equal",
              "value": "FILE_UPLOAD"
            }
          ]
        }
      }
    },
    {
      "id": "3db9c6a5-e319-4b0a-bc24-37f5d5a8e704",
      "name": "TikTok ‚Üí Direct Post",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3960, 120],
      "parameters": {
        "url": "https://open.tiktokapis.com/v2/post/publish/video/init/",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"post_info\": {\n    \"privacy_level\": \"PUBLIC_TO_EVERYONE\",\n    \"title\": {{ JSON.stringify($('Build Voiceover + Caption').first().json.caption) }},\n    \"is_aigc\": true,\n    \"brand_organic_toggle\": true\n  },\n  \"source_info\": {\n    \"source\": \"PULL_FROM_URL\",\n    \"video_url\": {{ JSON.stringify($('Heygen ‚Üí Get MP4 URL').first().json.data.video_url) }}\n  }\n}",
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_TIKTOK_CREDENTIAL",
          "name": "TikTok API"
        }
      }
    },
    {
      "id": "4b84b89d-b981-4737-9f70-ad0082411c55",
      "name": "TikTok ‚Üí Upload Init",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [3960, 340],
      "parameters": {
        "url": "https://open.tiktokapis.com/v2/post/publish/inbox/video/init/",
        "method": "POST",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "json",
        "jsonBody": "={\n  \"source_info\": {\n    \"source\": \"FILE_UPLOAD\",\n    \"video_size\": {{$binary.data?.data?.length || 0}},\n    \"chunk_size\": {{$binary.data?.data?.length || 0}},\n    \"total_chunk_count\": 1\n  }\n}",
        "options": {
          "timeout": 30000
        }
      },
      "credentials": {
        "httpHeaderAuth": {
          "id": "CONFIGURE_TIKTOK_CREDENTIAL",
          "name": "TikTok API"
        }
      }
    },
    {
      "id": "c0550c4b-2652-4d14-9210-00d739bfdd0f",
      "name": "TikTok ‚Üí PUT File",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [4200, 340],
      "parameters": {
        "url": "={{$json.data?.upload_url}}",
        "method": "PUT",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "video/mp4"
            },
            {
              "name": "Content-Length",
              "value": "={{$binary.data.data.length}}"
            },
            {
              "name": "Content-Range",
              "value": "={{'bytes 0-' + ($binary.data.data.length-1) + '/' + $binary.data.data.length}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "binary",
        "bodyBinaryPropertyName": "data",
        "options": {
          "timeout": 180000
        }
      }
    },
    {
      "id": "4019f336-1329-47d4-97dc-0fc3d08537f2",
      "name": "‚úÖ R√©ponse Finale",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [4450, 220],
      "parameters": {
        "responseBody": "={\n  \"status\": \"success\",\n  \"message\": \"Vid√©o TikTok g√©n√©r√©e et publi√©e avec succ√®s\",\n  \"data\": {\n    \"caption\": {{ JSON.stringify($('Build Voiceover + Caption').first().json.caption) }},\n    \"score\": {{ $('Build Voiceover + Caption').first().json.score }},\n    \"selection_method\": {{ JSON.stringify($('Build Voiceover + Caption').first().json.selection_method) }},\n    \"fallback_used\": {{ $('Build Voiceover + Caption').first().json.fallback_used }},\n    \"idea_number\": {{ $('Build Voiceover + Caption').first().json.idea_number }},\n    \"tiktok_publish\": {{ JSON.stringify($json.data || null) }}\n  },\n  \"timestamp\": {{ JSON.stringify(new Date().toISOString()) }}\n}",
        "options": {
          "responseCode": 200
        }
      }
    },
    {
      "id": "f9a0b1c2-3456-78f9-9999-999999999999",
      "name": "üß™ MODE TEST",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [100, 560],
      "parameters": {
        "content": "# ‚ö†Ô∏è WORKFLOW EN MODE TEST\n\n## Actions √† faire avant production :\n\n‚úÖ **1. Connecter les sub-nodes**\n- Chat Model ‚Üí Agent (AI_LANGUAGEMODEL)\n- Output Parser ‚Üí Agent (AI_OUTPUT_PARSER)\n\n‚úÖ **2. Google Sheets**\n- Cr√©er la feuille de logs\n- Configurer les credentials\n- Ajuster le documentId\n\n‚úÖ **3. Credentials √† configurer**\n- OpenAI API\n- KIE API (Header Auth)\n- Heygen API (Header Auth)\n- TikTok API (Header Auth)\n- Google Sheets OAuth2\n\n‚úÖ **4. Heygen**\n- Remplacer VOTRE_AVATAR_ID\n- Remplacer VOTRE_VOICE_ID\n\n‚úÖ **5. Tests**\n- Tester Agent IA + Parser\n- V√©rifier logging Sheets\n- Valider publication TikTok",
        "height": 580,
        "width": 340,
        "color": 1
      }
    }
  ],
  "connections": {
    "89d77201-7ec8-4ec6-b459-437452666d37": {
      "main": [[{"node": "4c410f0f-eb8f-436f-910a-20c57b080145", "type": "main", "index": 0}]]
    },
    "4c410f0f-eb8f-436f-910a-20c57b080145": {
      "main": [[{"node": "ffd348ab-8e65-4859-9c77-84f1f043802d", "type": "main", "index": 0}]]
    },
    "chat-model-openai": {
      "ai_languageModel": [[{"node": "ffd348ab-8e65-4859-9c77-84f1f043802d", "type": "ai_languageModel", "index": 0}]]
    },
    "output-parser-structured": {
      "ai_outputParser": [[{"node": "ffd348ab-8e65-4859-9c77-84f1f043802d", "type": "ai_outputParser", "index": 0}]]
    },
    "ffd348ab-8e65-4859-9c77-84f1f043802d": {
      "main": [[{"node": "3e215f6f-ac1f-4673-8c0b-fe675e97f251", "type": "main", "index": 0}]]
    },
    "3e215f6f-ac1f-4673-8c0b-fe675e97f251": {
      "main": [[{"node": "5d3c2f02-4bbd-4d84-8d1e-dda272e6af3a", "type": "main", "index": 0}]]
    },
    "5d3c2f02-4bbd-4d84-8d1e-dda272e6af3a": {
      "main": [[{"node": "02bc3649-ed04-4bb2-b53f-f7b0168acf65", "type": "main", "index": 0}]]
    },
    "02bc3649-ed04-4bb2-b53f-f7b0168acf65": {
      "main": [[{"node": "log-to-sheets", "type": "main", "index": 0}]]
    },
    "log-to-sheets": {
      "main": [[{"node": "dff878f1-4879-4e6b-b901-e5a4ccb09c50", "type": "main", "index": 0}]]
    },
    "dff878f1-4879-4e6b-b901-e5a4ccb09c50": {
      "main": [[{"node": "5ed21c34-259b-4717-9bf0-368b6d860a70", "type": "main", "index": 0}]]
    },
    "5ed21c34-259b-4717-9bf0-368b6d860a70": {
      "main": [[{"node": "5a46c8a6-baab-4c1e-920e-039eae74e3ed", "type": "main", "index": 0}]]
    },
    "5a46c8a6-baab-4c1e-920e-039eae74e3ed": {
      "main": [[{"node": "f4e7cdcf-0f5e-461a-a022-f294e9d3c707", "type": "main", "index": 0}]]
    },
    "f4e7cdcf-0f5e-461a-a022-f294e9d3c707": {
      "main": [[{"node": "43344644-4fa1-4ad3-a568-606c6971f261", "type": "main", "index": 0}]]
    },
    "43344644-4fa1-4ad3-a568-606c6971f261": {
      "main": [
        [{"node": "0fffd4d2-7484-4838-8a05-6369e96cbc5b", "type": "main", "index": 0}],
        [{"node": "5a46c8a6-baab-4c1e-920e-039eae74e3ed", "type": "main", "index": 0}]
      ]
    },
    "0fffd4d2-7484-4838-8a05-6369e96cbc5b": {
      "main": [[{"node": "a547449f-3cf1-4f4e-82fb-d4acb4bd3b6b", "type": "main", "index": 0}]]
    },
    "a547449f-3cf1-4f4e-82fb-d4acb4bd3b6b": {
      "main": [[{"node": "b815c767-4ae3-44f8-beb5-3a934eb39cc5", "type": "main", "index": 0}]]
    },
    "b815c767-4ae3-44f8-beb5-3a934eb39cc5": {
      "main": [
        [{"node": "3db9c6a5-e319-4b0a-bc24-37f5d5a8e704", "type": "main", "index": 0}],
        [{"node": "4b84b89d-b981-4737-9f70-ad0082411c55", "type": "main", "index": 0}]
      ]
    },
    "3db9c6a5-e319-4b0a-bc24-37f5d5a8e704": {
      "main": [[{"node": "4019f336-1329-47d4-97dc-0fc3d08537f2", "type": "main", "index": 0}]]
    },
    "4b84b89d-b981-4737-9f70-ad0082411c55": {
      "main": [[{"node": "c0550c4b-2652-4d14-9210-00d739bfdd0f", "type": "main", "index": 0}]]
    },
    "c0550c4b-2652-4d14-9210-00d739bfdd0f": {
      "main": [[{"node": "4019f336-1329-47d4-97dc-0fc3d08537f2", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateVersion": "2.1-with-agent-parser",
    "createdAt": "2025-10-27"
  }
}
